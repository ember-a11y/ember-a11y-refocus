{"version":3,"file":"navigation-narrator.js","sources":["../../src/components/navigation-narrator.gts"],"sourcesContent":["import Component from '@glimmer/component';\nimport { service } from '@ember/service';\nimport { tracked } from '@glimmer/tracking';\nimport { on } from '@ember/modifier';\nimport { registerDestructor } from '@ember/destroyable';\nimport { schedule, cancel } from '@ember/runloop';\n\nimport { defaultValidator } from '../utils/validators.ts';\n\nimport type RouterService from '@ember/routing/router-service';\nimport type Owner from '@ember/owner';\nimport type Transition from '@ember/routing/transition';\nimport type { Timer } from '@ember/runloop';\n\nexport interface NavigationNarratorSignature {\n  Args: {\n    /** Whether to include the skip link. Defaults to `true`. */\n    skipLink?: boolean;\n\n    /** CSS selector the skip link jumps to. Defaults to `'#main'`. */\n    skipTo?: string;\n\n    /** Text content of the skip link. Defaults to `'Skip to main content'`. */\n    skipText?: string;\n\n    /** Text announced by a screen reader after navigation. */\n    navigationText?: string;\n\n    /** Custom logic for determining whether a transition should trigger narration. */\n    routeChangeValidator?: (transition: Transition) => boolean;\n\n    /** Whether to ignore query param changes during route comparisons. Defaults to `false`. */\n    excludeAllQueryParams?: boolean;\n  };\n\n  Element: HTMLElement;\n}\n\n/**\n * ðŸŽ§ NavigationNarrator\n *\n * Announces route changes for screen readers using a visually-hidden element,\n * and optionally renders a \"Skip to main content\" link.\n *\n * Usage:\n * ```gjs\n * import { NavigationNarrator } from 'ember-a11y-refocus';\n *\n * <template>\n *   <NavigationNarrator />\n * </template>\n * ```\n */\nexport default class NavigationNarrator extends Component<NavigationNarratorSignature> {\n  @service declare readonly router: RouterService;\n\n  @tracked isSkipLinkFocused = false;\n\n  timer: Timer | undefined;\n  transition: Transition | undefined;\n\n  constructor(owner: Owner, args: NavigationNarratorSignature['Args']) {\n    super(owner, args);\n\n    this.router.on('routeDidChange', this.onRouteChange);\n\n    registerDestructor(this, () => {\n      // eslint-disable-next-line ember/no-runloop\n      cancel(this.timer);\n      this.timer = undefined;\n      this.router.off('routeDidChange', this.onRouteChange);\n    });\n  }\n\n  /** Whether to include the skip link. Defaults to `true`. */\n  get skipLink() {\n    return this.args.skipLink ?? true;\n  }\n\n  /** Selector for the skip link target. Defaults to `'#main'`. */\n  get skipTo() {\n    return this.args.skipTo ?? '#main';\n  }\n\n  /** Text for the skip link. Defaults to `'Skip to main content'`. */\n  get skipText() {\n    return this.args.skipText ?? 'Skip to main content';\n  }\n\n  /** Text announced by screen readers after route transition. */\n  get navigationText() {\n    return (\n      this.args.navigationText ??\n      'The page navigation is complete. You may now navigate the page content as you wish.'\n    );\n  }\n\n  /** Validator function for transitions. */\n  get routeChangeValidator() {\n    return this.args.routeChangeValidator ?? defaultValidator;\n  }\n\n  /** Whether to ignore query param changes. Defaults to `false`. */\n  get excludeAllQueryParams() {\n    return this.args.excludeAllQueryParams ?? false;\n  }\n\n  /** Whether the current transition includes query param changes. */\n  get hasQueryParams() {\n    if (\n      Object.keys(this.transition?.from?.queryParams || {}).length ||\n      Object.keys(this.transition?.to?.queryParams || {}).length > 0\n    ) {\n      return true;\n    } else {\n      return false;\n    }\n  }\n\n  onRouteChange = (transition: Transition) => {\n    this.transition = transition; // We need to do this because we can't pass an argument to a getter\n\n    // add a check to see if it's the same route\n    const hasSameRoute =\n      this.transition.from?.name === this.transition.to?.name;\n\n    if (this.excludeAllQueryParams && this.hasQueryParams && hasSameRoute) {\n      return;\n    }\n\n    const shouldFocus = this.routeChangeValidator(transition);\n\n    // leaving this here for now because maybe it needs to be used in a custom validator function\n    if (!shouldFocus) {\n      return;\n    }\n\n    // eslint-disable-next-line ember/no-runloop\n    this.timer = schedule('afterRender', this, function () {\n      this.timer = undefined;\n      (\n        document.body.querySelector(\n          '#ember-a11y-refocus-nav-message',\n        ) as HTMLElement\n      )?.focus();\n    });\n  };\n\n  handleSkipLinkFocus = () => {\n    this.isSkipLinkFocused = !this.isSkipLinkFocused;\n  };\n\n  <template>\n    <div\n      tabindex=\"-1\"\n      id=\"ember-a11y-refocus-nav-message\"\n      class=\"ember-sr-only ember-sr-only-focusable\"\n    >\n      {{this.navigationText}}\n    </div>\n\n    {{#if this.skipLink}}\n      <a\n        href={{this.skipTo}}\n        id=\"ember-a11y-refocus-skip-link\"\n        class=\"ember-a11y-refocus-skip-link\n          {{if this.isSkipLinkFocused 'active'}}\"\n        {{on \"focus\" this.handleSkipLinkFocus}}\n        {{on \"blur\" this.handleSkipLinkFocus}}\n      >\n        {{this.skipText}}\n      </a>\n    {{/if}}\n  </template>\n}\n"],"names":["NavigationNarrator","Component","g","prototype","service","i","tracked","timer","transition","constructor","owner","args","router","on","onRouteChange","registerDestructor","cancel","undefined","off","skipLink","skipTo","skipText","navigationText","routeChangeValidator","defaultValidator","excludeAllQueryParams","hasQueryParams","Object","keys","from","queryParams","length","to","hasSameRoute","name","shouldFocus","schedule","document","body","querySelector","focus","handleSkipLinkFocus","isSkipLinkFocused","setComponentTemplate","precompileTemplate","strictMode","scope"],"mappings":"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"}